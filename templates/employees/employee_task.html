{% extends 'layout/main.html' %}
{% load static %}
{% block title %} Employee Task | Dairy to Daily {% endblock title %}
{% block styles %}

<style>
    body {
        background-color: #f8f9fa;
    }
    .manage-orders-header {
        background-color: #333;
        color: #fff;
        padding: 1rem;
        text-align: center;
    }
    .card {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: none;
    }
    .btn-primary {
        background-color: #007bff;
        border: none;
    }
    .btn-primary:hover {
        background-color: #0056b3;
    }
    .btn-success {
        background-color: #28a745;
        border: none;
    }
    .btn-success:hover {
        background-color: #218838;
    }
    .order-list {
        max-height: 60vh;
        overflow-y: auto;
    }
    table th, table td {
        text-align: center;
        max-width: 200px;
    }
    
</style>

{% endblock styles %}

{% block content %}

<body>
    <!-- Header -->
    <div class="manage-orders-header">
        <h1>Manage Product Orders</h1>
        <p>Orders assigned to you are displayed below in FIFO order.</p>
    </div>

    <!-- Orders Section -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-10 offset-md-1">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Orders List</h4>
                    </div>
                    <div class="card-body order-list">
                        <!-- Orders Table -->
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer Name</th>
                                    <th>Customer Area</th>
                                    <th>Customer Address</th>
                                    <th>Product Name</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in orders %}
                                <tr id="order-{{ order.id }}">
                                    <td>{{ order.id }}</td>
                                    <td>{{ order.user.username }}</td>
                                    <td>{{ order.shipping_details.area }}</td>
                                    <td>{{ order.shipping_details.address }}</td>
                                    <td>{{ order.product_name }}</td>
                                    <td><span class="badge bg-warning text-dark order-status">{{ order.status }}</span></td>
                                    <td>
                                        {% if order.status == "Pending" %}
                                        <button class="btn btn-primary btn-sm start-btn" data-order-id="{{ order.id }}">Start</button>
                                        <button class="btn btn-success btn-sm deliver-btn" data-order-id="{{ order.id }}" disabled>Deliver</button>
                                        {% elif order.status == "Shipping" %}
                                        <button class="btn btn-primary btn-sm" data-order-id="{{ order.id }}" disabled>Start</button>
                                        <button class="btn btn-success btn-sm deliver-btn" data-order-id="{{ order.id }}">Deliver</button>
                                        {% else %}
                                        <button class="btn btn-primary btn-sm" disabled>Start</button>
                                        <button class="btn btn-success btn-sm" disabled>Deliver</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">No orders to manage.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

{% endblock content %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Listen for click events on "Start" and "Deliver" buttons
        const startButtons = document.querySelectorAll('.start-btn');
        const deliverButtons = document.querySelectorAll('.deliver-btn');
    
        startButtons.forEach(button => {
            button.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                const socket = new WebSocket('ws://' + window.location.host + '/ws/orders/' + orderId + '/');

                // Handle WebSocket open event
                socket.onopen = function(event) {
                    console.log("WebSocket connected for order ID:", orderId);
                    sendOrderStatusUpdate(socket, orderId, 'Shipping');
                };

                socket.onerror = function(event) {
                    console.error("WebSocket error:", event);
                };
    
                // Handle WebSocket error
               
    
                // Ensure WebSocket is open before sending data
                function sendOrderStatusUpdate(socket, orderId, status) {
                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({
                            type: 'order_status_update',
                            order_id: orderId,
                            status: status
                        }));
                    } else {
                        console.error("WebSocket is not open for order ID:", orderId);
                    }
                }
            });
        });
    
        deliverButtons.forEach(button => {
            button.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                const socket = new WebSocket('ws://' + window.location.host + '/ws/orders/' + orderId + '/');
    
                // Handle WebSocket open event
                socket.onopen = function(event) {
                    console.log("WebSocket connected for order ID:", orderId);
                    sendOrderStatusUpdate(socket, orderId, 'Completed');
                };
    
                // Handle WebSocket error
                socket.onerror = function(error) {
                    console.error("WebSocket error for order ID:", orderId, error);
                };
    
                // Ensure WebSocket is open before sending data
                function sendOrderStatusUpdate(socket, orderId, status) {
                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({
                            type: 'order_status_update',
                            order_id: orderId,
                            status: status
                        }));
                    } else {
                        console.error("WebSocket is not open for order ID:", orderId);
                    }
                }
            });
        });
    });
    
</script>

{% endblock scripts %}